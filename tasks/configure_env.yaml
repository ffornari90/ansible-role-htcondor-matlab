- name: Get hostname
  shell: hostname
  register: hostname

- name: Get master private ip
  get_url:
    url: http://169.254.169.254/latest/meta-data/local-ipv4
    dest: /tmp/master_private_ip
  register: master_private_ip
  when: "'vnode-0' in hostname.stdout"

- name: Get master public ip
  get_url:
    url: http://169.254.169.254/latest/meta-data/public-ipv4
    dest: /tmp/master_public_ip
  when: "'vnode-0' in hostname.stdout"

- name: Read master public ip content 
  slurp:
    src: /tmp/master_public_ip
  register: file_content
  when: "'vnode-0' in hostname.stdout"

- name: Store file content in a variable
  set_fact:
    master_public_ip: "{{ file_content.content | b64decode }}"
  when: "'vnode-0' in hostname.stdout"

- name: Remove lines containing "vnode-0" from the hosts file
  become: yes
  replace:
    path: /etc/hosts
    regexp: '^.*vnode-0.*$'
    replace: ''

- name: Add a line to /etc/hosts
  become: yes
  lineinfile:
    path: /etc/hosts
    line: "master_private_ip.stdout vnode-0.localdomain vnode-0"
